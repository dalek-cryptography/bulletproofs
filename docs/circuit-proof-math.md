Arithmetic Circuit Proofs
=========================

An arithmetic circuit is a directed acyclic graph, where every node with indegree zero is an input gate, and every other node is either a multiplication gate or an addition gate. Multiplication gates can either be variable multiplication gates, where two variables are multiplied together, or constant multiplication gates, where a variable is multiplied by a constant. Addition gates can also be either variable addition gates or constant addition gates.

The goal of an *arithmetic circuit proof* is for a prover to convince a verifier that a particular set of values \\({\textbf{v}}\\) satisfy the constraints represented by the arithmetic circuit, without revealing any additional information about the values \\({\textbf{v}}\\).

The prover will use the efficient [inner product protocol](../inner_product_proof/index.html) to do this, so we want to work towards expressing the arithmetic circuit's conditions in terms of a single inner product. The prover begins with a vector of secret values \\({\textbf{v}}\\), and a vector of Pedersen commitments to those secret values \\({\textbf{V}}\\). The prover will send \\({\textbf{V}}\\) to the verifier, along with the proof.

Notation
--------

Dimensions of vectors:

* \\(m\\) — number of secret values \\({\textbf{v}}\\),
* \\(n\\) — number of variable multiplication gates represented by \\(\textbf{a}\_L, \textbf{a}\_R, \textbf{a}\_O\\),
* \\(q\\) — number of linear constraints represented by \\(\textbf{W}\_L, \textbf{W}\_R, \textbf{W}\_O, \textbf{W}\_V\\).

In the [Bulletproofs paper][bp_website], matrices are labeled as \\(\textbf{W}\_L, \textbf{W}\_R, \textbf{W}\_O, \textbf{W}\_V\\). We will keep this notation, but will note to readers not to confuse the \\(\textbf{W}\_{L,R,O,V}\\) notation for being a vector of points.

We will use the notation described in the [`notation`](../notes/index.html#notation) section of the notes. In addition, we rename two more variables from the paper, to make it clear which variables are blinding factors and use lower-case variable \\(q\\) to not confuse it with a group element:
\\[
\begin{aligned}
    \beta         &\xrightarrow{} \tilde{o} \\\\
	Q             &\xrightarrow{} q \\\\
\end{aligned}
\\]


From an arithmetic circuit to a constraint system
-------------------------------------------------

An arithmetic circuit represents a set of _constraints_ on some inputs, where the constraints are satisfied if and only if the inputs are correctly applied to the circuit and all of the gates in the arithmetic circuit graph perform their operations correctly. Therefore, an arithmetic circuit can also be expressed as a set of constraints on inputs.

One type of gate in an arithmetic circuit is a _variable multiplication gate_, which takes two input variables and multiplies them to get an output. If for all of the multiplication gates in a circuit, \\(\textbf{a}\_L\\) is the vector of the first input to each gate, \\(\textbf{a}\_R\\) is the vector of the second input to each gate, and \\(\textbf{a}\_O\\) is the vector of results, then the following equation will represent the relationship between the wires of all the multiplication gates in the circuit:

\\[
\textbf{a}\_L \circ \textbf{a}\_R = \textbf{a}\_O
\\]

Other types of gates in arithmetic circuits can be represented as a collection of linear constraints:

* _constant multiplication gates_ are represented by multiplying the input variable by a corresponding constant in a matrix (\\(\textbf{W}\_L, \textbf{W}\_R, \textbf{W}\_O, \textbf{W}\_V\\)),
* _constant addition gates_ are represented by multiplying the input variable by one and adding the constant in \\( \textbf{c}\\),
* _variable addition gates_ are represented by multiplying both input variables by one.

All of these constraints are represented together in the following equation:

\\[
\textbf{W}\_L \cdot \textbf{a}\_L +
\textbf{W}\_R \cdot \textbf{a}\_R +
\textbf{W}\_O \cdot \textbf{a}\_O =
\textbf{W}\_V \cdot \textbf{v} +
\textbf{c}
\\]


### Building constraints

Bulletproofs framework allows making proofs of arbitrary circuits _on the fly_, without a trusted setup.
This allows instantiating a circuit from a _family of circuits_ parametrized by public values (such as bit-width in case of a range proof)
and commitments to the secret inputs. As a result, the circuit instantiation can be thought of as a _challenge_
generated by verifier to a prover.

The prover starts out by committing to its secret inputs \\(\textbf{v}\\)
and obtaining \\(m\\) _variables_ representing these inputs.

Then, the prover creates linear combinations of available variables that can be of two kinds:

1. _high-level_: the input secrets \\(\textbf{v}\\),
2. or _low-level_: the internal inputs and outputs of multiplication gates \\(\textbf{a}\_L, \textbf{a}\_R, \textbf{a}\_O\\).

The prover performs a combination of the following operations to generate the circuit
using linear constraints and multiplication gates:

1. **Allocate a multiplier:** a new multiplication gate is added represented by 3 variables \\(a_L, a_R, a_O\\), for left input, right input and output value respectively.
2. **Add a constraint:** a linear combination of any number of variables is encoded into appropriate positions in matrices \\(\textbf{W}\_L, \textbf{W}\_R, \textbf{W}\_O, \textbf{W}\_V\\) and a vector of constants \\(\textbf{c}\\).
3. **Request a challenge scalar:** a random scalar returned in response to committed high-level variables.

### Unconstrained variables

Often a circuit is formed using _gadgets_: subcircuits that represent various constraints defined in a higher-level protocol.
The “wires” connecting such subcircuits are called _uncommitted variables_ and created from left and right variables \\(a\_L, a\_R\\) of
auxilliary multiplication gates (output variables \\(a\_O\\) intentionally left unconstrained).


### Circuit as a challenge

Challenge scalars can be used to construct circuits more efficiently.

For example, a proof of permutation (verifiable shuffle) can be done by proving equality of
two polynomials sampled at a challenge point, where roots of each polynomial
represent secret values of the corresponding side of a permutation:

\\[
 \\{a,b\\} = \\{c,d\\}  \iff  (a-x)\cdot(b-x) = (c-x)\cdot(d-x),
\\] where \\(x\\) is a random challenge, sampled after all values \\(a,b,c,d\\) are committed.

Making a proof of permutation using a static circuit would require
building a [sorting network][sorting_network] that requires significantly more multiplication gates.

[sorting_network]: https://en.wikipedia.org/wiki/Sorting_network


### Representation of constraints

The matrices \\(\textbf{W}\_L, \textbf{W}\_R, \textbf{W}\_O, \textbf{W}\_V\\) are usually very sparse:
most constraints apply to very few variables. As a result, constraints are represented as lists
of pairs \\((i, w)\\) where \\(i\\) is a variable index, and `w` is its (non-zero) weight.

Multiplication of a matrix by a vector is implemented via multiplication of each weight \\(w\\) by 
a scalar in the vector at a corresponding index \\(i\\). This way, all zero-weight terms are automatically skipped.


Combining statements using challenge variables
----------------------------------------------

We can rewrite the statement about multiplication gates into an inner product equation, using the challenge variable \\(y\\).
We can do this for a random challenge \\(y\\) because \\({\mathbf{b}} = {\mathbf{0}}\\) if and only
if[^1] \\({\langle {\mathbf{b}}, {\mathbf{y}}^{n} \rangle} = 0\\). The equation \\(\textbf{a}\_L \circ \textbf{a}\_R = \textbf{a}\_O\\) becomes:

\\[
\langle \textbf{a}\_L \circ \textbf{a}\_R - \textbf{a}\_O ,
\textbf{y}^n \rangle = 0
\\]

We can rewrite the statement about the linear constraints into an inner product equation, using the challenge variable \\(z\\).
We can do this for a random challenge \\(z\\), for the same reason as above. The equation
\\(
\textbf{W}\_L \cdot \textbf{a}\_L +
\textbf{W}\_R \cdot \textbf{a}\_R +
\textbf{W}\_O \cdot \textbf{a}\_O =
\textbf{W}\_V \cdot \textbf{v} +
\textbf{c}
\\) 
becomes:

\\[
\langle z \textbf{z}^q,
\textbf{W}\_L \cdot \textbf{a}\_L +
\textbf{W}\_R \cdot \textbf{a}\_R +
\textbf{W}\_O \cdot \textbf{a}\_O -
\textbf{W}\_V \cdot \textbf{v} -
\textbf{c}
\rangle = 0
\\]

We can combine these two inner product equations, since they are offset by different multiples of challenge variable \\(z\\).
The statement about multiplication gates is multiplied by \\(z^0\\), while the statements about addition and scalar multiplication gates
are multiplied by a powers of \\(z\\) between \\(z^1\\) and \\(z^q\\). Combining the two equations gives us:

\\[
\langle \textbf{a}\_L \circ \textbf{a}\_R - \textbf{a}\_O ,
\textbf{y}^n \rangle +
\langle z \textbf{z}^q, 
\textbf{W}\_L \cdot \textbf{a}\_L +
\textbf{W}\_R \cdot \textbf{a}\_R +
\textbf{W}\_O \cdot \textbf{a}\_O -
\textbf{W}\_V \cdot \textbf{v} -
\textbf{c}
\rangle = 0
\\]

[^1]: This is because the polynomial in terms of \\(y\\) is zero at every point
if and only if every term of it is zero. The verifier is going to sample
a random \\(y\\) after the prover commits to all the values forming the terms of
that polynomial, making the probability that the prover cheated negligible.
This trick allows implementing logical `AND` with any number of terms.

Rearranging into a single inner product statement
-------------------------------------------------

We want to work towards expressing the arithmetic circuit's conditions in terms of a single inner product, so that we can use the inner product argument to represent it in a more compact and efficient-to-verify form. 
Our goal is to rearrange the equation above so that terms
involving \\({\mathbf{a}}\_{L}\\) and \\({\mathbf{a}}\_{O}\\) appear only on the left-hand side, terms
involving \\({\mathbf{a}}\_{R}\\) appear only on the right-hand side, and
non-secret terms (which the verifier can compute on its own) are
factored out into a new term \\(\delta(y, z) \\).

If we break apart the equation into individual terms, we can write it as:

\\[
\langle z \textbf{z}^q,
\textbf{c} + \textbf{W}\_V \cdot \textbf{v} \rangle =
\langle \textbf{a}\_L \circ \textbf{a}\_R, \textbf{y}^n \rangle -
\langle \textbf{a}\_O, \textbf{y}^n \rangle + 
\langle z \textbf{z}^q, 
\textbf{W}\_L \cdot \textbf{a}\_L \rangle +
\langle z \textbf{z}^q, 
\textbf{W}\_R \cdot \textbf{a}\_R \rangle +
\langle z \textbf{z}^q, 
\textbf{W}\_O \cdot \textbf{a}\_O \rangle
\\]

Merge the statements containing \\(\textbf{a}\_O \\):

\\[
\langle z \textbf{z}^q,
\textbf{c} + \textbf{W}\_V \cdot \textbf{v} \rangle =
\langle \textbf{a}\_L, 
\textbf{y}^n \circ \textbf{a}\_R \rangle + 
\langle \textbf{a}\_L,
z \textbf{z}^q \cdot \textbf{W}\_L \rangle +
\langle \textbf{a}\_O, 
-\textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O \rangle +
\langle \textbf{a}\_R, 
z \textbf{z}^q \cdot \textbf{W}\_R \rangle
\\]

Multiply the \\( \langle \textbf{a}\_R, 
z \textbf{z}^q \cdot \textbf{W}\_R \rangle \\) term by \\(\textbf{y}^n\\) one one side of the inner product and by \\(\textbf{y}^{-n}\\) on the other side:

\\[
\langle z \textbf{z}^q,
\textbf{c} + \textbf{W}\_V \cdot \textbf{v} \rangle =
\langle \textbf{a}\_L, 
\textbf{y}^n \circ \textbf{a}\_R \rangle + 
\langle \textbf{a}\_L,
z \textbf{z}^q \cdot \textbf{W}\_L \rangle +
\langle \textbf{a}\_O, 
-\textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O \rangle +
\langle \textbf{y}^n \circ \textbf{a}\_R, 
\textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R) \rangle
\\]

Merge the statements containing \\(\textbf{y}^n \circ \textbf{a}\_R\\):

\\[
\langle z \textbf{z}^q,
\textbf{c} + \textbf{W}\_V \cdot \textbf{v} \rangle =
\langle \textbf{a}\_L + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R), 
\textbf{y}^n \circ \textbf{a}\_R \rangle + 
\langle \textbf{a}\_L,
z \textbf{z}^q \cdot \textbf{W}\_L \rangle +
\langle \textbf{a}\_O, 
-\textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O \rangle
\\]

Add \\(\delta(y, z) = \langle \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R), z \textbf{z}^q \cdot \textbf{W}\_L \rangle \\) to both sides:

\\[
\begin{aligned}
\langle z \textbf{z}^q,
\textbf{c} &+ \textbf{W}\_V \cdot \textbf{v} \rangle + \delta(y, z) \\\\
&= \langle \textbf{a}\_L + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R), 
\textbf{y}^n \circ \textbf{a}\_R \rangle + 
\langle \textbf{a}\_L,
z \textbf{z}^q \cdot \textbf{W}\_L \rangle \\\\ &+
\langle \textbf{a}\_O, 
-\textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O \rangle + 
\langle \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R), z \textbf{z}^q \cdot \textbf{W}\_L \rangle
\end{aligned}
\\]

Merge the terms containing \\(z \textbf{z}^q \cdot \textbf{W}\_L\\):

\\[
\begin{aligned}
\langle z \textbf{z}^q,
\textbf{c} &+ \textbf{W}\_V \cdot \textbf{v} \rangle + \delta(y, z) \\\\
&= \langle \textbf{a}\_L + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R), 
\textbf{y}^n \circ \textbf{a}\_R \rangle + 
\langle \textbf{a}\_L + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R),
z \textbf{z}^q \cdot \textbf{W}\_L \rangle +
\langle \textbf{a}\_O, 
-\textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O \rangle
\end{aligned}
\\]

Merge the terms containing \\(\textbf{a}\_L + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R)\\):

\\[
\langle z \textbf{z}^q,
\textbf{c} + \textbf{W}\_V \cdot \textbf{v} \rangle + \delta(y, z) =
\langle \textbf{a}\_L + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R), 
\textbf{y}^n \circ \textbf{a}\_R +
z \textbf{z}^q \cdot \textbf{W}\_L \rangle +
\langle \textbf{a}\_O, 
-\textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O \rangle
\\]

We want to combine a sum of two inner products \\(\langle a, b \rangle + \langle c, d \rangle\\) into one inner product.
To do that, we will take a term of a polynomial formed by a linear combination of these products with respect to a challenge scalar \\(x\\). Specifically, the 2nd degree term of \\(\langle a \cdot x + c \cdot x^2, b \cdot x + d \cdot x^0 \rangle\\) is equal to
\\( \langle a, b \rangle + \langle c, d \rangle\\).

To apply this technique to the above equation we assign \\(a, b, c, d\\) the following values:

\\[
\begin{aligned}
a &= \textbf{a}\_L + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R) \\\\
b &= \textbf{y}^n \circ \textbf{a}\_R +
z \textbf{z}^q \cdot \textbf{W}\_L\\\\
c &= \textbf{a}\_O \\\\
d &= -\textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O
\end{aligned}
\\]

Next, we combine \\(a, b, c, d\\) using the equation \\( \langle a \cdot x + c \cdot x^2, b \cdot x + d \cdot x^0 \rangle \\). When we take its second degree, we recover a single inner product, which was our original goal:

\\[
\langle z \textbf{z}^q,
\textbf{c} + \textbf{W}\_V \cdot \textbf{v} \rangle + \delta(y, z) = 
\text{2nd degree of }
\langle (\textbf{a}\_L + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R)) \cdot x + 
\textbf{a}\_O \cdot x^2,
(\textbf{y}^n \circ \textbf{a}\_R +
z \textbf{z}^q \cdot \textbf{W}\_L) \cdot x +
(-\textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O) \cdot x^0 \rangle 
\\]

Distribute the \\(x\\) values: 

\\[
\langle z \textbf{z}^q,
\textbf{c} + \textbf{W}\_V \cdot \textbf{v} \rangle + \delta(y, z) = 
\text{2nd degree of }
\langle \textbf{a}\_L \cdot x + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R) \cdot x + 
\textbf{a}\_O \cdot x^2,
\textbf{y}^n \circ \textbf{a}\_R \cdot x +
z \textbf{z}^q \cdot \textbf{W}\_L \cdot x -
\textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O \rangle
\\]

This is equivalent to the equation we started with, but has a single
inner product with \\({\mathbf{a}}\_{L}\\) and \\({\mathbf{a}}\_{O}\\) on the left, \\({\mathbf{a}}\_{R}\\) on
the right, and non-secret terms factored out.

Blinding the inner product
--------------------------

In the current form, the vectors in the inner-product reveal information about the values
\\({\mathbf{a}}\_{L}\\), \\({\mathbf{a}}\_{R}\\) and \\({\mathbf{a}}\_{O}\\), which in turn reveal the values \\(\mathbf{v}\\).
And since the inner-product argument is not zero-knowledge, the vectors cannot be used in the inner-product argument either.
To solve this problem, the prover chooses two vectors of blinding factors

\\[
{\mathbf{s}}\_{L}, {\mathbf{s}}\_{R} \\;{\xleftarrow{\\$}}\\; {\mathbb Z\_p}^{n},
\\]

and uses them to blind \\(\mathbf{a}\_L\\) and \\(\mathbf{a}\_R\\) within left and right sides of the inner product respectively.

\\[
\begin{aligned}
\mathbf{a}\_{L} &\leftarrow \mathbf{a}\_{L} + \mathbf{s}\_{L} \cdot x^2 \\\\
\mathbf{a}\_{R} &\leftarrow \mathbf{a}\_{R} + \mathbf{s}\_{R} \cdot x^2
\end{aligned}
\\]

The blinding factors are multiplied by \\(x^2\\) so that when the substitution is made into the \\(\textbf{l}(x)\\) and \\(\textbf{r}(x)\\) equations, \\({\mathbf{s}}\_{L}\\) will be in the 3rd degree of \\(x\\) in \\(\textbf{l}(x)\\), and \\({\mathbf{s}}\_{L}\\) will be in the 3rd degree of \\(x\\) in \\(\textbf{r}(x)\\). As a result, the blinding factors will not interfere with the value \\(t_2\\), which is the 2nd degree of \\(\langle {\mathbf{l}}(x), {\mathbf{r}}(x) \rangle\\).

Note: multiplication outputs \\(\mathbf{a}\_O\\) do not need their own blinding factors:
they are automatically blinded by \\(\mathbf{s}\_{L}\\) since both \\(\mathbf{a}\_L\\)
and \\(\mathbf{a}\_O\\) are terms in the same (left) side of the inner product.

We now construct vector polynomials \\({\mathbf{l}}(x)\\) and \\({\mathbf{r}}(x)\\),
which represent the left and right sides of the input to the inner-product equation, with these new definitions:
\\[
\begin{aligned}
  {\mathbf{l}}(x) &= (\textbf{a}\_L + \textbf{s}\_L \cdot x^2) \cdot x + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R) \cdot x + \textbf{a}\_O \cdot x^2 \\\\
  &= \textbf{a}\_L \cdot x + \textbf{s}\_L \cdot x^3 + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R) \cdot x + \textbf{a}\_O \cdot x^2 \\\\
  {\mathbf{r}}(x) &= \textbf{y}^n \circ (\textbf{a}\_R + \textbf{s}\_R \cdot x^2) \cdot x + z \textbf{z}^q \cdot \textbf{W}\_L \cdot x - \textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O \\\\
  &= \textbf{y}^n \circ \textbf{a}\_R \cdot x + \textbf{y}^n \circ \textbf{s}\_R \cdot x^3 + z \textbf{z}^q \cdot \textbf{W}\_L \cdot x - \textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O
\end{aligned}
\\]

When we take the inner product of \\({\mathbf{l}}(x)\\) and \\({\mathbf{l}}(x)\\), we get:

\\[
\begin{aligned}
  t(x) &= {\langle {\mathbf{l}}(x), {\mathbf{r}}(x) \rangle} \\\\
       &= t\_{1} x + t\_{2} x^{2} + t\_{3} x^{3} + t\_{4} x^{4} + t\_{5} x^{5} + t\_{6} x^{6} \\\\
       &= \sum_{i=1}^{6} t_i x^i
\end{aligned}
\\]

Notice that the second degree of \\(t(x)\\) does not include any blinding factors (because the blinding factors end up in the third or greater degrees of \\(t(x)\\)) and only contains the inner product forms of the initial arithmetic gate statements that we are trying to prove:

\\[
\begin{aligned}
t_2 &= \text{2nd degree of } \langle {\mathbf{l}}(x), {\mathbf{r}}(x) \rangle
\\\\
&= \langle z \textbf{z}^q,
\textbf{c} + \textbf{W}\_V \cdot \textbf{v} \rangle + \delta(y, z) \\\\
&= \langle \textbf{a}\_L \circ \textbf{a}\_R, \textbf{y}^n \rangle -
\langle \textbf{a}\_O, \textbf{y}^n \rangle + 
\langle z \textbf{z}^q, 
\textbf{W}\_L \cdot \textbf{a}\_L \rangle +
\langle z \textbf{z}^q, 
\textbf{W}\_R \cdot \textbf{a}\_R \rangle +
\langle z \textbf{z}^q, 
\textbf{W}\_O \cdot \textbf{a}\_O \rangle + \delta(y, z)
\end{aligned}
\\]

Proving that \\(t_2\\) is correct
---------------------------------

The prover first forms a commitment to the coefficients of \\(t(x)\\), then convinces the verifier that these commit to the correct \\(t(x)\\) by evaluating the polynomial at a challenge point \\(x\\). This proves that \\(t(x)\\) is correct and follows the following equation:

\\[
\begin{aligned}
t(x) &= \sum\_{i=1}^{6} x^i t\_{i} \\\\
t_2 &= \langle z \textbf{z}^q,
\textbf{c} + \textbf{W}\_V \cdot \textbf{v} \rangle + \delta(y, z) \\\\
\end{aligned}
\\]

We define \\(\textbf{V}\\) as the vector of Pedersen commitments to \\(\textbf{v}\\), and \\(T_i\\) as the Pedersen commitment to \\(t_i\\) for \\(i \in [1, 3, 4, 5, 6]\\):

\\[
\begin{aligned}
V_j &= B \cdot v_j + \widetilde{B} \cdot \tilde{v}\_j \quad \forall j \in [1, m] \\\\
T_i &= B \cdot t_i + \widetilde{B} \cdot \tilde{t}\_i \quad \forall i \in [1, 3, 4, 5, 6] \\\\
\end{aligned}
\\]

The prover forms these commitments, and sends them to the verifier. These commitments are related to each other and to \\(t(x)\\) by the following diagram:

\\[
\begin{aligned}
  t(x) B                         &\quad &= \quad & x^2 \langle z \textbf{z}^q , \textbf{W}\_V \cdot \textbf{v} \rangle \cdot B                      & \quad &+ \quad & x^2 \big(\langle  z \textbf{z}^q , \textbf{c} \rangle + \delta(y,z)\big) B   &\quad &+\quad & \sum\_{i = 1,3,4,5,6} &x^i t\_{i} B                       \\\\
    +                            &\quad &  \quad &  +                                                                                               & \quad &  \quad &  +                                                                           &\quad & \quad &                                     &           +                       \\\\
  {\tilde{t}}(x) {\widetilde{B}} &\quad &= \quad & x^2 \langle z \textbf{z}^q , \textbf{W}\_V \cdot \tilde{\textbf{v}} \rangle \cdot \widetilde{B}  & \quad &+ \quad & 0 {\widetilde{B}}                                                            &\quad &+\quad & \sum\_{i = 1,3,4,5,6} &x^i \tilde{t\_{i}} {\widetilde{B}} \\\\
  \shortparallel                 &\quad &  \quad & \shortparallel                                                                                   & \quad &  \quad & \shortparallel                                                               &\quad & \quad &                                     &    \shortparallel                 \\\\
                                 &\quad &= \quad & x^2 \langle z \textbf{z}^q , \textbf{W}\_V \cdot \textbf{V} \rangle                              & \quad &+ \quad & x^2 \big(\langle  z \textbf{z}^q , \textbf{c} \rangle + \delta(y,z)\big) B   &\quad &+\quad & \sum\_{i = 1,3,4,5,6} &x^i T\_{i}
\end{aligned}
\\]

Notice that the sum of each column is a commitment to the variable in the top row using the blinding factor in the second row. The sum of all of the columns is
\\(t(x) B + {\tilde{t}}(x) {\widetilde{B}}\\), a commitment to the value
of \\(t\\) at the point \\(x\\), using the synthetic blinding factor[^2]:
\\[
  {\tilde{t}}(x) = x^2 \langle z \textbf{z}^q , \textbf{W}\_V \cdot \tilde{\textbf{v}} \rangle + \sum\_{i = 1,3,4,5,6} x^i \tilde{t}\_{i}
\\]

To convince the verifier that
\\(t(x) = \delta(y,z) + \sum\_{i=1}^{6} x^i t\_{i}\\), the prover sends
the opening \\(t(x), {\tilde{t}}(x)\\) to the verifier, who uses the
bottom row of the diagram to check consistency:
\\[
  t(x) B + {\tilde{t}}(x) {\widetilde{B}} \stackrel{?}{=} x^2 \langle z \textbf{z}^q , \textbf{W}\_V \cdot \textbf{V} \rangle + x^2 \big(\langle  z \textbf{z}^q , \textbf{c} \rangle + \delta(y,z)\big) B + \sum\_{i = 1,3,4,5,6} x^i T\_{i}
\\]

[^2]: The blinding factor is synthetic in the sense that it is
    synthesized from the blinding factors of the other commitments.

Proving that \\(\textbf{l}(x)\\), \\(\textbf{r}(x)\\) are correct
-----------------------------------------------------------------

We want to relate \\({\mathbf{l}}(x)\\) and \\({\mathbf{r}}(x)\\) to commitments
to \\({\mathbf{a}}\_{L}\\), \\({\mathbf{a}}\_{R}\\), \\({\mathbf{s}}\_{L}\\), and
\\({\mathbf{s}}\_{R}\\). Since \\[
{\mathbf{r}}(x) = \textbf{y}^n \circ \textbf{a}\_R \cdot x + \textbf{y}^n \circ \textbf{s}\_R \cdot x^3 + z \textbf{z}^q \cdot \textbf{W}\_L \cdot x - \textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O
\\]
we need commitments to \\({\mathbf{y}}^{n} \circ {\mathbf{a}}\_{R}\\) and
\\({\mathbf{y}}^{n} \circ {\mathbf{s}}\_{R}\\). However, since the prover
must form commitments before receiving the verifier’s challenge \\(y\\), the
prover can only commit to \\({\mathbf{a}}\_{R}\\) and \\({\mathbf{s}}\_{R}\\). Since the prover’s
commitments are to \\({\mathbf{a}}\_{R}\\) and \\({\mathbf{s}}\_{R}\\), the verifier needs to transmute
the prover’s commitment over
\\(
({\mathbf{a}}\_{L},{\mathbf{a}}\_{R}, {\widetilde{a}})
\\)
into a commitment over
\\(
({\mathbf{a}}\_{L}, {\mathbf{y}}^{n} \circ {\mathbf{a}}\_{R}, {\widetilde{a}})
\\)
(and similarly for \\({\mathbf{s}}\_{R}\\)).
To do this, notice that
\\[
\begin{aligned}
  \text{commitment over }({\mathbf{a}}\_{L}, {\mathbf{a}}\_{R}, {\widetilde{a}})
  &=
  {\langle {\mathbf{a}}\_{L}, {\mathbf{G}} \rangle} + {\langle {\mathbf{a}}\_{R}, {\mathbf{H}} \rangle} + {\widetilde{a}} {\widetilde{B}} \\\\
  &=
  {\langle {\mathbf{a}}\_{L}, {\mathbf{G}} \rangle} + {\langle {\mathbf{y}}^{n} \circ {\mathbf{a}}\_{R}, {\mathbf{y}}^{-n} \circ {\mathbf{H}} \rangle} + {\widetilde{a}} {\widetilde{B}},
\end{aligned}
\\]
so that by changing generators to
\\({\mathbf{H}}' = {\mathbf{y}}^{-n} \circ {\mathbf{H}}\\), the point which
is a commitment to
\\(({\mathbf{a}}\_{L}, {\mathbf{a}}\_{R}, {\widetilde{a}})\\) with respect to
\\(({\mathbf{G}}, {\mathbf{H}}, {\widetilde{a}})\\) is transmuted into a
commitment to
\\(({\mathbf{a}}\_{L}, {\mathbf{y}}^{n} \circ {\mathbf{a}}\_{R}, {\widetilde{a}})\\)
with respect to \\(({\mathbf{G}}, {\mathbf{H}}', {\widetilde{a}})\\).

We define the following commitments over the components of \\({\mathbf{l}}(x)\\) and \\({\mathbf{r}}(x)\\):

\\[
\begin{aligned}
A_I &= \widetilde{B} \cdot \tilde{a} + \langle \textbf{G} , \textbf{a}\_L \rangle + \langle \textbf{H}, \textbf{a}\_R \rangle \\\\
A_O &= \widetilde{B} \cdot \tilde{o} + \langle \textbf{G} , \textbf{a}\_O \rangle \\\\
W_L &= \langle z \textbf{z}^q \cdot \textbf{W}\_L , \textbf{H}' \rangle \\\\
W_R &= \textbf{y}^{-n} \circ (\langle z \textbf{z}^q \cdot \textbf{W}\_R) , \textbf{G} \rangle \\\\
W_O &= \langle z \textbf{z}^q \cdot \textbf{W}\_O , \textbf{H}' \rangle \\\\
S &= \widetilde{B} \cdot \tilde{s} + \langle \textbf{G} , \textbf{s}\_L \rangle + \langle \textbf{H}, \textbf{s}\_R \rangle
\end{aligned}
\\]

The prover forms these commitments, and sends them to the verifier.

For reference, here are the equations for \\({\mathbf{l}}(x)\\) and \\({\mathbf{r}}(x)\\):

\\[
\begin{aligned}
  {\mathbf{l}}(x)  &= \textbf{a}\_L \cdot x + \textbf{s}\_L \cdot x^3 + \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R) \cdot x + \textbf{a}\_O \cdot x^2 \\\\
  {\mathbf{r}}(x)  &= \textbf{y}^n \circ \textbf{a}\_R \cdot x + \textbf{y}^n \circ \textbf{s}\_R \cdot x^3 + z \textbf{z}^q \cdot \textbf{W}\_L \cdot x - \textbf{y}^n + z \textbf{z}^q \cdot \textbf{W}\_O
\end{aligned}
\\]

To relate the prover’s commitments to
\\({\mathbf{l}}(x)\\) and \\({\mathbf{r}}(x)\\), we use the following diagram:

\\[
\begin{aligned}
  {\langle {\mathbf{l}}(x), {\mathbf{G}} \rangle}         &\quad &= \quad & {\langle {\mathbf{a}}\_L \cdot x, {\mathbf{G}} \rangle}      & \quad &+ \quad & {\langle {\mathbf{a}}\_O \cdot x^2, {\mathbf{G}} \rangle}  & \quad &+ \quad& \langle \textbf{y}^{-n} \circ (z \textbf{z}^q \cdot \textbf{W}\_R) \cdot x , \textbf{G} \rangle      &\quad &+\quad & \langle \textbf{s}\_L \cdot x^3 , \textbf{G} \rangle \\\\
    +                        &\quad &  \quad &  +                          & \quad &  \quad &  +             & \quad &  \quad& +                             &\quad & \quad & +   \\\\
  {\langle {\mathbf{r}}(x), {\mathbf{H}}' \rangle}  &\quad &= \quad & \langle \textbf{a}\_R \cdot x, {\mathbf{H}} \rangle & \quad &+ \quad & - \langle \textbf{1}, \textbf{H} \rangle  & \quad &+ \quad& \langle z \textbf{z}^q \cdot (\textbf{W}\_L \cdot x + \textbf{W}\_O), \textbf{H}' \rangle &\quad &+\quad & \langle \textbf{s}\_R \cdot x^3 , \textbf{H} \rangle \\\\
    +                        &\quad &  \quad &  +                          & \quad &  \quad &  +             & \quad &  \quad& +                             &\quad & \quad & +   \\\\
  \tilde{e} \cdot \widetilde{B}  &\quad &= \quad & \tilde{a} \cdot x \cdot \widetilde{B} & \quad &+ \quad & \tilde{o} \cdot x^2 \cdot \widetilde{B}  & \quad &+ \quad& 0 &\quad &+\quad & \tilde{s} \cdot x^3 \cdot \widetilde{B} \\\\
    \shortparallel           &\quad &  \quad & \shortparallel              & \quad &  \quad & \shortparallel & \quad &  \quad& \shortparallel                &\quad & \quad & \shortparallel   \\\\
                 &\quad &= \quad & x \cdot A_I                         & \quad &+ \quad & x^2 \cdot A_O - \langle \textbf{1}, \textbf{H} \rangle & \quad &+ \quad& W_L \cdot x + W_R \cdot x + W_O                       &\quad &+\quad & x^3 \cdot S
\end{aligned}
\\]

We can interpret the rows and columns similarly to the previous diagram:
the sum of each column is a vector Pedersen commitment with left and right halves from the first and second rows respectively
and blinding factor from the third row.
The sum of all of the columns is a vector
Pedersen commitment to \\({\mathbf{l}}(x)\\) and \\({\mathbf{r}}(x)\\) with
synthetic blinding factor \\({\widetilde{e}}\\).

To convince the verifier that
\\(t(x) = {\langle {\mathbf{l}}(x), {\mathbf{r}}(x) \rangle}\\), the prover
sends \\({\widetilde{e}}\\) to the verifier, who uses the bottom row
to compute
\\[
\begin{aligned}
  P &= -{\widetilde{e}} {\widetilde{B}} + x \cdot A_I + x^2 \cdot A_O - \langle \textbf{1}, \textbf{H} \rangle + W_L \cdot x + W_R \cdot x + W_O + x^3 \cdot S \\\\
\end{aligned}
\\]
if the prover is honest, this is
\\(P = {\langle {\mathbf{l}}(x), {\mathbf{G}} \rangle} + {\langle {\mathbf{r}}(x), {\mathbf{H}}' \rangle}\\),
so the verifier uses \\(P\\) and \\(t(x)\\) as inputs to the inner-product protocol
to prove that
\\(t(x) = {\langle {\mathbf{l}}(x), {\mathbf{r}}(x) \rangle}\\).



Prover’s algorithm
------------------

The protocol begins with the prover computing commitments to the secret values \\(\mathbf{v}\\):

\\[
V_i \gets \operatorname{Com}(v_i, {\widetilde{v}\_i}) = v\_i \cdot B + {\widetilde{v}\_i} \cdot {\widetilde{B}}
\\] where each \\(\widetilde{v}\_i\\) is sampled randomly.

The prover then [builds constraints](#building-constraints), allocating necessary multiplication gates on the fly,
assigning values to the multiplication left, right and output wires \\(\mathbf{a}\_{L}, \mathbf{a}\_{R}, \mathbf{a}\_{O}\\).

Once all multiplication wires are assigned, the prover commits to them via vector Pedersen commitments:

\\[
\begin{aligned}
\tilde{a} \\;&{\xleftarrow{\\$}}\\; \mathbb Z\_p \\\\
\tilde{o} \\;&{\xleftarrow{\\$}}\\; \mathbb Z\_p \\\\
A_I          &= \widetilde{B} \cdot \tilde{a} + \langle \textbf{G} , \textbf{a}\_L \rangle + \langle \textbf{H}, \textbf{a}\_R \rangle \\\\
A_O          &= \widetilde{B} \cdot \tilde{o} + \langle \textbf{G} , \textbf{a}\_O \rangle \\\\
\end{aligned}
\\]

The prover also computes blinding factors \\(\textbf{s}\_L, \textbf{s}\_R\\)
for the left and right multiplication values and commits to them:

\\[
\begin{aligned}
\mathbf{s}\_{L} \\; &{\xleftarrow{\\$}}\\; {\mathbb Z\_p}^{n} \\\\
\mathbf{s}\_{R} \\; &{\xleftarrow{\\$}}\\; {\mathbb Z\_p}^{n} \\\\
\tilde{s} \\;       &{\xleftarrow{\\$}}\\; \mathbb Z\_p \\\\
S                   &= \widetilde{B} \cdot \tilde{s} + \langle \textbf{G} , \textbf{s}\_L \rangle + \langle \textbf{H}, \textbf{s}\_R \rangle
\end{aligned}
\\]

The prover adds \\(A_I\\), \\(A_O\\) and \\(S\\) to the protocol transcript
and obtains challenge scalars \\(y,z \in {\mathbb Z\_p}\\) from the transcript.

The next step is to flatten the constraints using \\(q\\) powers of challenge \\(z\\).
The prover factors out weights from the following inner product and pre-computes the left vector:

\\[
\langle z \textbf{z}^q , \textbf{W}\_V \cdot \textbf{V} \rangle = \langle z \textbf{z}^q \cdot \textbf{W}\_V, \textbf{V} \rangle
\\]

This way, the prover flattens four sets of constraints in four vectors:

\\[
\begin{aligned}
\mathbf{w}\_L &= z \textbf{z}^q \cdot \textbf{W}\_L, \\\\
\mathbf{w}\_R &= z \textbf{z}^q \cdot \textbf{W}\_R, \\\\
\mathbf{w}\_O &= z \textbf{z}^q \cdot \textbf{W}\_O, \\\\
\mathbf{w}\_V &= z \textbf{z}^q \cdot \textbf{W}\_V,
\end{aligned}
\\]
where each of \\(\mathbf{w}\_L, \mathbf{w}\_R, \mathbf{w}\_O\\) has length \\(n\\) and \\(\mathbf{w}\_V\\) has length \\(m\\).

The prover then constructs the blinded polynomials and their inner product:

\\[
\begin{aligned}
  {\mathbf{l}}(x)  &= \textbf{a}\_L \cdot x + \textbf{s}\_L \cdot x^3 + \textbf{y}^{-n} \circ \mathbf{w}\_R \cdot x + \textbf{a}\_O \cdot x^2 \\\\
  {\mathbf{r}}(x)  &= \textbf{y}^n \circ \textbf{a}\_R \cdot x + \textbf{y}^n \circ \textbf{s}\_R \cdot x^3 + \mathbf{w}\_L \cdot x - \textbf{y}^n + \mathbf{w}\_O \\\\
  t(x)             &= {\langle {\mathbf{l}}(x), {\mathbf{r}}(x) \rangle}
\end{aligned}
\\]

The prover generates blinding factors for terms \\(t\_1, t\_3, t\_4, t\_5, t\_6\\) and creates Pedersen commitments to them
(term \\(t\_0\\) is known to be zero and term \\(t\_2\\) is being proven):

\\[
\begin{aligned}
  &\tilde{t}\_1, \tilde{t}\_3, \tilde{t}\_4, \tilde{t}\_5, \tilde{t}\_6 \\;{\xleftarrow{\\$}}\\; \mathbb Z\_p \\\\
  &T_i \gets \operatorname{Com}(t_i, {\tilde{t}\_i}) = t\_i \cdot B + {\tilde{t}\_i} \cdot {\widetilde{B}} \\\\
\end{aligned}
\\]

The prover adds \\(T_1, T_3, T_4, T_5, T_6\\) to the protocol transcript
and obtains challenge scalar \\(x \in {\mathbb Z\_p}\\) from the transcript.

The prover computes the synthetic blinding factors \\({\tilde{t}}(x)\\) at point \\(x\\) and \\(\tilde{e}\\):

\\[
\begin{aligned}
  \tilde{t}\_2    &= \langle \mathbf{w}\_V, \tilde{\textbf{v}} \rangle \\\\
  {\tilde{t}}(x)  &= \sum\_{i = 1}^{6} x^i \tilde{t}\_{i} \\\\
  {\tilde{e}}     &= \tilde{a} \cdot x + \tilde{o} \cdot x^2 + \tilde{s} \cdot x^3 \\\\
\end{aligned}
\\]

The prover adds \\(t(x), {\tilde{t}}(x), {\tilde{e}}\\) to the protocol transcript, obtains a challenge scalar \\(w \in {\mathbb Z\_p}\\), and uses it to create a point \\(Q\\):

\\[
	Q \gets  w \cdot B
\\]

The prover evaluates polynomials \\(\mathbf{l}(x), \mathbf{r}(x)\\) and performs the [inner product argument](../inner_product_proof/index.html) to prove the relation:
\\[
\operatorname{PK}\left\\{
  ({\mathbf{G}}, {\mathbf{H}}' \in {\mathbb G}^{n}, P', Q \in {\mathbb G}; {\mathbf{l}}, {\mathbf{r}} \in {\mathbb Z\_p}^{n})
  : P' = {\langle {\mathbf{l}}, {\mathbf{G}} \rangle} + {\langle {\mathbf{r}}, {\mathbf{H}}' \rangle} + {\langle {\mathbf{l}}, {\mathbf{r}} \rangle} Q
\right\\}
\\] where \\({\mathbf{H}}' = {\mathbf{y}}^{-n} \circ {\mathbf{H}}\\).

The result of the inner product proof is a list of \\(2k\\) points and \\(2\\) scalars, where \\(k = \log_2(n)\\): \\(\\{L\_k, R\_k, \\dots, L\_1, R\_1, a, b\\}\\).

The complete circuit proof consists of \\(13+2k\\) 32-byte elements:
\\[
  \\{A\_I, A\_O, S, T\_1, T\_3, T\_4, T\_5, T\_6, t(x), {\tilde{t}}(x), \tilde{e}, L\_k, R\_k, \\dots, L\_1, R\_1, a, b\\}
\\]



Verifier’s algorithm
--------------------

TBD.



[bp_website]: https://crypto.stanford.edu/bulletproofs/